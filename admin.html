<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - OFF-THE-RECORD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #fefefe;
            color: #333;
            line-height: 1.4;
            padding: 30px;
        }

        .admin-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .admin-header a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: #333;
            text-decoration: none;
            transition: all 0.15s ease;
        }

        .admin-header a:hover {
            background: #333;
            border-color: #333;
            color: #fff;
        }

        h1 {
            font-size: 20px;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .container {
            display: flex;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .left-panel {
            width: 280px;
            flex-shrink: 0;
        }

        .right-panel {
            flex: 1;
            min-width: 0;
            display: flex;
            gap: 20px;
        }

        .catalog-panel {
            width: 600px;
            flex-shrink: 0;
        }

        .extra-panels {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-panel {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .control-panel-title {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .stat-total {
            padding-top: 8px;
            margin-top: 4px;
            border-top: 1px solid #eee;
            font-weight: bold;
        }

        .toggle-group {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .toggle-header {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .toggle-row:last-child {
            margin-bottom: 0;
        }

        .toggle-label {
            font-size: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 22px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #333;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        .quick-links {
            margin-top: 15px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .quick-links a,
        .quick-links .legend-btn {
            color: #333;
            text-decoration: underline;
            font-size: 11px;
        }

        .quick-links .legend-btn {
            cursor: pointer;
        }

        .quick-links .legend-btn:hover {
            color: #666;
        }

        .legend-dropdown {
            display: none;
            margin-top: 8px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
            font-size: 11px;
            line-height: 1.8;
        }

        .legend-dropdown.show {
            display: block;
        }

        .toggle-subheader {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 12px;
            margin-bottom: 8px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .toggle-subheader:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        /* Right Panel - Media Catalog */
        .catalog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .catalog-title {
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .add-btn {
            background: #333;
            color: #fff;
            border: none;
            padding: 8px 16px;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-btn:hover {
            background: #555;
        }

        .catalog-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px 4px 0 0;
        }

        .catalog-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .catalog-table thead {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1;
        }

        .catalog-table th {
            text-align: left;
            padding: 6px 4px;
            border-bottom: 2px solid #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 10px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .catalog-table th:hover {
            background: #f5f5f5;
        }

        .catalog-table th .sort-arrow {
            margin-left: 2px;
            opacity: 0.3;
            font-size: 9px;
        }

        .catalog-table th.sorted .sort-arrow {
            opacity: 1;
        }

        .catalog-table td {
            padding: 4px;
            border-bottom: 1px solid #eee;
        }

        .catalog-table tr:hover {
            background: #f9f9f9;
        }

        .emoji-cell {
            font-size: 14px;
            text-align: center;
            width: 28px;
        }

        .status-cell {
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s;
            text-align: center;
            width: 24px;
            font-size: 10px;
        }

        .status-cell:hover {
            transform: scale(1.3);
        }

        .time-cell {
            text-align: center;
            width: 40px;
            font-size: 10px;
            color: #666;
        }

        .date-cell {
            text-align: center;
            width: 65px;
            font-size: 10px;
            color: #666;
            white-space: nowrap;
        }

        .id-cell {
            font-size: 10px;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .id-cell a {
            color: #333;
            text-decoration: none;
            border-bottom: 1px dotted #999;
        }

        .id-cell a:hover {
            border-bottom-color: #333;
        }

        .chapter-num-cell {
            text-align: center;
            width: 28px;
            padding: 4px 2px !important;
        }

        .chapter-num-cell .ch-num {
            display: inline-block;
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            font-size: 10px;
            font-weight: normal;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: #fff;
        }

        .chapter-name-cell {
            padding-left: 4px !important;
        }

        .chapter-name-cell a {
            color: #333;
            text-decoration: none;
            border-bottom: 1px dotted #999;
            font-size: 11px;
        }

        .chapter-name-cell a:hover {
            border-bottom-color: #333;
        }

        /* Inline Add Form */
        .inline-add-form {
            padding: 6px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }

        .inline-form-row {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .inline-status,
        .inline-emoji {
            width: 36px;
            padding: 4px 2px;
            font-family: inherit;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            cursor: pointer;
        }

        .inline-id {
            flex: 1;
            min-width: 60px;
            padding: 4px 6px;
            font-family: inherit;
            font-size: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .inline-chapter {
            width: 140px;
            padding: 4px 6px;
            font-family: inherit;
            font-size: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .inline-time {
            width: 45px;
            padding: 4px 6px;
            font-family: inherit;
            font-size: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        .inline-add-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 14px;
            font-weight: bold;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .inline-add-btn:hover {
            background: #555;
        }

        /* Add Media Form */
        .add-form {
            display: none;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .add-form.active {
            display: block;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            font-family: inherit;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .form-actions button {
            padding: 8px 16px;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #333;
        }

        .btn-generate {
            background: #333;
            color: #fff;
        }

        .btn-cancel {
            background: #fff;
            color: #333;
        }

        .output-code {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a1a;
            color: #0f0;
            font-size: 11px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-break: break-all;
            display: none;
        }

        .output-code.active {
            display: block;
        }

        .copy-btn {
            margin-top: 10px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 4px;
        }

        .output-section {
            margin-top: 20px;
        }

        .step-box {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .step-label {
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            color: #333;
        }

        .step-box .output-code {
            display: block;
            margin: 0;
            padding: 12px;
            font-size: 12px;
        }

        .step-box .copy-btn {
            margin-top: 8px;
        }

        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #333;
            text-decoration: underline;
            font-size: 12px;
        }

        /* Chapter Locking */
        .lock-actions {
            display: flex;
            gap: 8px;
        }

        .lock-btn {
            background: #fff;
            color: #333;
            border: 1px solid #333;
            padding: 6px 12px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .lock-btn:hover {
            background: #333;
            color: #fff;
        }

        .chapter-lock-list {
            display: flex;
            flex-wrap: nowrap;
            gap: 3px;
            margin-bottom: 20px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow-x: auto;
        }

        .chapter-lock-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            min-width: 22px;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            color: #333;
        }

        .chapter-lock-item:hover {
            background: #e0e0e0;
        }

        .chapter-lock-item.locked {
            background: #ffcccc;
            color: #990000;
        }

        .chapter-lock-item input[type="checkbox"] {
            display: none;
        }

        .chapter-lock-item .chapter-num {
            font-weight: bold;
        }

        .chapter-lock-item .chapter-title {
            display: none;
        }

        .chapter-lock-item .lock-icon {
            display: none;
        }

        .chapter-lock-item.locked::after {
            content: 'üîí';
            position: absolute;
            font-size: 6px;
            bottom: 1px;
            right: 1px;
        }

        .collapsible-header {
            cursor: pointer;
        }

        .collapse-arrow {
            font-size: 10px;
            margin-left: 6px;
            transition: transform 0.2s;
        }

        .chapter-lock-list.collapsed {
            display: none;
        }

        .collapse-arrow.rotated {
            transform: rotate(-90deg);
        }

        .save-indicator {
            color: #28a745;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            margin-right: 10px;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .chapter-lock-item .lock-icon {
            font-size: 14px;
            opacity: 0;
        }

        .chapter-lock-item.locked .lock-icon {
            opacity: 1;
        }

        .reset-btn {
            background: #fff;
            color: #333;
            border: 1px solid #333;
            padding: 4px 10px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
        }

        .reset-btn:hover {
            background: #333;
            color: #fff;
        }

        .reset-btn.done {
            background: #28a745;
            border-color: #28a745;
            color: #fff;
        }

        .install-options {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .mini-form-group {
            margin-bottom: 8px;
        }

        .mini-form-group label {
            display: block;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            margin-bottom: 3px;
        }

        .mini-form-group input {
            width: 100%;
            padding: 5px 8px;
            font-family: inherit;
            font-size: 11px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .mini-form-row {
            display: flex;
            gap: 8px;
        }

        .mini-form-row .mini-form-group {
            flex: 1;
        }

        .install-stats {
            margin-top: 10px;
            padding: 8px 10px;
            background: #e8f5e9;
            border-radius: 4px;
            font-size: 11px;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: #2e7d32;
        }

        @media (max-width: 800px) {
            .container {
                flex-direction: column;
            }
            .left-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <a href="./" title="Back to site">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </a>
        <h1>Admin Panel</h1>
    </header>

    <div class="container">
        <div class="left-panel">
            <div class="toggle-group">
                <div class="toggle-header">Settings</div>

                <div class="toggle-subheader">Site</div>
                <div class="toggle-row">
                    <span class="toggle-label">Locked Previews</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showLockedPreviews">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-subheader">Reader</div>
                <div class="toggle-row">
                    <span class="toggle-label">Page Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="allowPageMode" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Font Size</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="allowFontSize" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Bookmarks</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="allowBookmarks" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-subheader">Media</div>
                <div class="toggle-row">
                    <span class="toggle-label">Captions</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showCaptions">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Twitter Embeds</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="twitterEmbeds">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-subheader">Home</div>
                <div class="toggle-row">
                    <span class="toggle-label">Maintenance Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="maintenanceMode">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Random Button</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="randomButtonText">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Credential Carousel</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="credentialCarousel">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-subheader">Navigation</div>
                <div class="toggle-row">
                    <span class="toggle-label">Comments</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="allowComments" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="quick-links">
                <a href="./">Site</a>
                <a href="./full-book.html">Full Book</a>
                <a href="https://github.com/anthonyfenech/off-the-record" target="_blank">GitHub</a>
                <span class="legend-btn" id="legendBtn">Legend</span>
            </div>

            <div class="legend-dropdown" id="legendDropdown">
                <div>üü¢ Live (in chapter)</div>
                <div>üü° Pending (placeholder)</div>
                <div>üî¥ Cut (unused)</div>
            </div>
        </div>

        <div class="right-panel">
            <div class="catalog-panel">
            <!-- Chapter Locking Section -->
            <div class="catalog-header collapsible-header" id="chapterLockHeader">
                <span class="catalog-title">Chapter Locking <span class="collapse-arrow" id="chapterLockArrow">‚ñº</span></span>
                <div class="lock-actions">
                    <span class="save-indicator" id="saveIndicator">Saved!</span>
                    <button class="lock-btn" id="lockAllBtn">Lock All</button>
                    <button class="lock-btn" id="unlockAllBtn">Unlock All</button>
                </div>
            </div>

            <div class="chapter-lock-list collapsed" id="chapterLockList">
                <!-- Populated dynamically -->
            </div>

            <div style="margin: 30px 0; border-top: 2px solid #333;"></div>

            <div class="catalog-header">
                <span class="catalog-title">Media Catalog</span>
                <button class="add-btn" id="addMediaBtn">+ Add</button>
            </div>

            <div class="add-form" id="addForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Chapter</label>
                        <select id="mediaChapter">
                            <option value="">Select chapter...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="mediaType">
                            <option value="photo">Photo</option>
                            <option value="newspaper">Newspaper</option>
                            <option value="link">Link</option>
                            <option value="tweet">Tweet</option>
                            <option value="email">Email</option>
                            <option value="text">Text Message</option>
                            <option value="video">Video</option>
                            <option value="audio">Audio</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Caption (what shows when clicked)</label>
                        <input type="text" id="mediaCaption" placeholder="e.g., Tigers dugout, 2019">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>File Name (in assets folder)</label>
                        <input type="text" id="mediaSrc" placeholder="e.g., dugout-photo.jpg">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn-generate" id="generateBtn">Generate Code</button>
                    <button class="btn-cancel" id="cancelBtn">Cancel</button>
                </div>

                <div class="output-section" id="outputSection" style="display:none;">
                    <div class="step-box">
                        <div class="step-label">STEP 1: Add to data/media.js</div>
                        <div class="output-code" id="mediaCode"></div>
                        <button class="copy-btn" data-target="mediaCode">Copy</button>
                    </div>
                    <div class="step-box">
                        <div class="step-label">STEP 2: Paste in chapter text where you want the emoji</div>
                        <div class="output-code" id="spanCode"></div>
                        <button class="copy-btn" data-target="spanCode">Copy</button>
                    </div>
                </div>
            </div>

            <div class="catalog-container">
                <table class="catalog-table" id="catalogTable">
                    <thead>
                        <tr>
                            <th data-sort="status" title="üü¢ Live (in chapter) | üü° Pending (placeholder) | üî¥ Cut (unused)">‚óè <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="icon">‚¨° <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="id">Media ID <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="chapterNum"># <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="chapterName">Chapter <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="date">Date <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="time">Time <span class="sort-arrow">‚Üï</span></th>
                        </tr>
                    </thead>
                    <tbody id="catalogBody">
                        <!-- Populated dynamically from media.js -->
                    </tbody>
                </table>
            </div>

            <!-- Inline Add Form -->
            <div class="inline-add-form" id="inlineAddForm">
                <div class="inline-form-row">
                    <select class="inline-status" id="inlineStatus" title="Status">
                        <option value="green">üü¢</option>
                        <option value="yellow">üü°</option>
                        <option value="red">üî¥</option>
                    </select>
                    <select class="inline-emoji" id="inlineEmoji" title="Type">
                        <option value="üì∑">üì∑</option>
                        <option value="üì∞">üì∞</option>
                        <option value="üîó">üîó</option>
                        <option value="üê¶">üê¶</option>
                        <option value="‚úâÔ∏è">‚úâÔ∏è</option>
                        <option value="üí¨">üí¨</option>
                        <option value="üé¨">üé¨</option>
                        <option value="üéôÔ∏è">üéôÔ∏è</option>
                    </select>
                    <input type="text" class="inline-id" id="inlineId" placeholder="Media ID">
                    <select class="inline-chapter" id="inlineChapter" title="Chapter">
                        <option value="">‚Äî</option>
                    </select>
                    <input type="text" class="inline-time" id="inlineTime" placeholder="Time">
                    <button class="inline-add-btn" id="inlineAddBtn">+</button>
                </div>
            </div>
            </div><!-- end catalog-panel -->

            <div class="extra-panels">
                <div class="control-panel">
                    <div class="control-panel-title">Install Prompt</div>
                    <div class="toggle-row">
                        <span class="toggle-label">Enabled</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="installPromptEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span class="toggle-label">Dismissed</span>
                        <button class="reset-btn" id="resetInstallPrompt">Reset</button>
                    </div>
                    <div class="install-options">
                        <div class="mini-form-group">
                            <label>Message</label>
                            <input type="text" id="installMessage" placeholder="Install message...">
                        </div>
                        <div class="mini-form-group">
                            <label>Button</label>
                            <input type="text" id="installButton" placeholder="Button text...">
                        </div>
                        <div class="mini-form-row">
                            <div class="mini-form-group">
                                <label>Delay (sec)</label>
                                <input type="number" id="installDelay" min="0" max="60" value="1">
                            </div>
                            <div class="mini-form-group">
                                <label>Auto-hide (sec)</label>
                                <input type="number" id="installAutoHide" min="0" max="120" value="0" placeholder="0=never">
                            </div>
                        </div>
                    </div>
                    <div class="install-stats">
                        <span class="stat-label">Installs:</span>
                        <span class="stat-value" id="installCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { MEDIA_CONTENT } from './data/media.js';
        import { CHAPTERS } from './data/chapters.js';

        // Chapter titles for lookups
        const chapterTitles = CHAPTERS.map(ch => ch.title);

        // ====== CHAPTER LOCKING ======
        const chapterLockList = document.getElementById('chapterLockList');
        const lockAllBtn = document.getElementById('lockAllBtn');
        const unlockAllBtn = document.getElementById('unlockAllBtn');

        // Load locked chapters from localStorage
        function getLockedChapters() {
            const stored = localStorage.getItem('admin_lockedChapters');
            return stored ? JSON.parse(stored) : [];
        }

        // Save locked chapters to localStorage
        function saveLockedChapters(lockedIds) {
            localStorage.setItem('admin_lockedChapters', JSON.stringify(lockedIds));
            showSaveIndicator();
        }

        // Show save indicator briefly
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 1500);
            }
        }

        // Render chapter lock list
        function renderChapterLockList() {
            const lockedChapters = getLockedChapters();

            chapterLockList.innerHTML = CHAPTERS.map((chapter, index) => {
                const chapterId = chapter.id;
                const isLocked = lockedChapters.includes(chapterId);
                return `
                    <label class="chapter-lock-item ${isLocked ? 'locked' : ''}" data-chapter-id="${chapterId}" title="${chapterId}. ${chapter.title}">
                        <input type="checkbox" ${isLocked ? 'checked' : ''}>
                        <span class="chapter-num">${chapterId}</span>
                    </label>
                `;
            }).join('');

            // Add event listeners
            chapterLockList.querySelectorAll('.chapter-lock-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => {
                    const chapterId = parseInt(item.dataset.chapterId);
                    let lockedChapters = getLockedChapters();

                    if (checkbox.checked) {
                        if (!lockedChapters.includes(chapterId)) {
                            lockedChapters.push(chapterId);
                        }
                        item.classList.add('locked');
                    } else {
                        lockedChapters = lockedChapters.filter(id => id !== chapterId);
                        item.classList.remove('locked');
                    }

                    saveLockedChapters(lockedChapters);
                });
            });
        }

        // Lock all chapters
        lockAllBtn.addEventListener('click', () => {
            const allChapterIds = CHAPTERS.map(ch => ch.id);
            saveLockedChapters(allChapterIds);
            renderChapterLockList();
        });

        // Unlock all chapters
        unlockAllBtn.addEventListener('click', () => {
            saveLockedChapters([]);
            renderChapterLockList();
        });

        // Initial render
        renderChapterLockList();

        // Collapse toggle for chapter locking
        const chapterLockHeader = document.getElementById('chapterLockHeader');
        const chapterLockArrow = document.getElementById('chapterLockArrow');
        chapterLockHeader.addEventListener('click', (e) => {
            if (e.target.closest('.lock-btn')) return; // Don't toggle when clicking buttons
            chapterLockList.classList.toggle('collapsed');
            chapterLockArrow.classList.toggle('rotated');
        });

        // Populate catalog table from media.js
        const catalogBody = document.getElementById('catalogBody');

        // Check if media is used in any chapter
        function isMediaInUse(mediaId) {
            for (let i = 0; i < CHAPTERS.length; i++) {
                if (CHAPTERS[i].content.includes(`data-media-id="${mediaId}"`)) {
                    return true;
                }
            }
            return false;
        }

        // Find which chapter a media ID is used in (returns object with num and name)
        function findChapterForMedia(mediaId) {
            for (let i = 0; i < CHAPTERS.length; i++) {
                if (CHAPTERS[i].content.includes(`data-media-id="${mediaId}"`)) {
                    return {
                        num: CHAPTERS[i].id,
                        name: chapterTitles[i],
                        full: `${CHAPTERS[i].id}. ${chapterTitles[i]}`
                    };
                }
            }
            return { num: null, name: null, full: '‚Äî' };
        }

        // Get status: üü¢ Live (in use), üü° Pending (placeholder), üî¥ Cut (unused)
        // Check localStorage for manual overrides first
        function getStatus(id, media) {
            const override = localStorage.getItem(`media_status_${id}`);
            if (override === 'green') return { icon: 'üü¢', label: 'Live', sort: 1 };
            if (override === 'yellow') return { icon: 'üü°', label: 'Pending', sort: 2 };
            if (override === 'red') return { icon: 'üî¥', label: 'Cut', sort: 3 };

            // Auto-detect if no override
            if (media.placeholder) return { icon: 'üü°', label: 'Pending', sort: 2 };
            if (isMediaInUse(id)) return { icon: 'üü¢', label: 'Live', sort: 1 };
            return { icon: 'üî¥', label: 'Cut', sort: 3 };
        }

        // Format duration (expects seconds or "mm:ss" string)
        function formatDuration(duration) {
            if (!duration) return '‚Äî';
            if (typeof duration === 'string') return duration;
            const mins = Math.floor(duration / 60);
            const secs = duration % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Build media list - show ALL media, not just active
        const allMedia = Object.entries(MEDIA_CONTENT)
            .map(([id, media]) => {
                const status = getStatus(id, media);
                const chapter = findChapterForMedia(id);
                return {
                    id,
                    icon: media.emoji || 'üì∑',
                    type: media.type,
                    src: media.src,
                    chapterNum: chapter.num,
                    chapterName: chapter.name,
                    caption: media.caption,
                    status: status.icon,
                    statusLabel: status.label,
                    statusSort: status.sort,
                    date: media.date || '‚Äî',
                    time: formatDuration(media.duration)
                };
            });

        // Render table
        function renderTable(data) {
            catalogBody.innerHTML = data.map(item => {
                const chapterLink = item.chapterNum
                    ? `<a href="./full-book.html#chapter-${item.chapterNum}" target="_blank">${item.chapterName}</a>`
                    : '‚Äî';
                const chapterNumBox = item.chapterNum
                    ? `<span class="ch-num">${item.chapterNum}</span>`
                    : '‚Äî';
                const idLink = item.src
                    ? `<a href="${item.src}" target="_blank" title="Open ${item.id}">${item.id}</a>`
                    : item.id;
                return `
                <tr>
                    <td class="status-cell" data-id="${item.id}" title="${item.statusLabel} - Click to change">${item.status}</td>
                    <td class="emoji-cell">${item.icon}</td>
                    <td class="id-cell" title="${item.id}">${idLink}</td>
                    <td class="chapter-num-cell">${chapterNumBox}</td>
                    <td class="chapter-name-cell">${chapterLink}</td>
                    <td class="date-cell">${item.date}</td>
                    <td class="time-cell">${item.time}</td>
                </tr>
            `;
            }).join('');
        }

        renderTable(allMedia);

        // Status click-to-toggle
        document.getElementById('catalogBody').addEventListener('click', (e) => {
            if (e.target.classList.contains('status-cell')) {
                const id = e.target.dataset.id;
                const current = e.target.textContent.trim();

                // Cycle: üî¥ ‚Üí üü° ‚Üí üü¢ ‚Üí üî¥
                let next, nextLabel, nextValue;
                if (current === 'üî¥') {
                    next = 'üü°'; nextLabel = 'Pending'; nextValue = 'yellow';
                } else if (current === 'üü°') {
                    next = 'üü¢'; nextLabel = 'Live'; nextValue = 'green';
                } else {
                    next = 'üî¥'; nextLabel = 'Cut'; nextValue = 'red';
                }

                // Update display
                e.target.textContent = next;
                e.target.title = `${nextLabel} - Click to change`;

                // Save to localStorage
                localStorage.setItem(`media_status_${id}`, nextValue);
            }
        });

        // Toggle functionality
        function loadSettings() {
            return {
                showOverload: localStorage.getItem('admin_showOverload') === 'true',
                showLockedPreviews: localStorage.getItem('admin_showLockedPreviews') === 'true',
                showCaptions: localStorage.getItem('admin_showCaptions') === 'true',
                allowPageMode: localStorage.getItem('admin_allowPageMode') !== 'false',
                allowFontSize: localStorage.getItem('admin_allowFontSize') !== 'false',
                allowBookmarks: localStorage.getItem('admin_allowBookmarks') !== 'false',
                allowComments: localStorage.getItem('admin_allowComments') !== 'false',
                twitterEmbeds: localStorage.getItem('admin_twitterEmbeds') === 'true',
                maintenanceMode: localStorage.getItem('admin_maintenanceMode') === 'true',
                randomButtonText: localStorage.getItem('admin_randomButtonText') === 'true',
                credentialCarousel: localStorage.getItem('admin_credentialCarousel') === 'true',
                installPromptEnabled: localStorage.getItem('admin_installPromptEnabled') === 'true',
                installMessage: localStorage.getItem('admin_installMessage') || 'Install OFF-THE-RECORD for easy access and offline reading',
                installButton: localStorage.getItem('admin_installButton') || 'Install',
                installDelay: parseInt(localStorage.getItem('admin_installDelay') || '1'),
                installAutoHide: parseInt(localStorage.getItem('admin_installAutoHide') || '0'),
                installCount: parseInt(localStorage.getItem('admin_installCount') || '0')
            };
        }

        function saveSetting(key, value) {
            localStorage.setItem('admin_' + key, value);
        }

        function init() {
            const settings = loadSettings();

            document.getElementById('showOverload').checked = settings.showOverload;
            document.getElementById('showLockedPreviews').checked = settings.showLockedPreviews;
            document.getElementById('showCaptions').checked = settings.showCaptions;
            document.getElementById('allowPageMode').checked = settings.allowPageMode;
            document.getElementById('allowFontSize').checked = settings.allowFontSize;
            document.getElementById('allowBookmarks').checked = settings.allowBookmarks;
            document.getElementById('allowComments').checked = settings.allowComments;
            document.getElementById('twitterEmbeds').checked = settings.twitterEmbeds;
            document.getElementById('maintenanceMode').checked = settings.maintenanceMode;
            document.getElementById('randomButtonText').checked = settings.randomButtonText;
            document.getElementById('credentialCarousel').checked = settings.credentialCarousel;
            document.getElementById('installPromptEnabled').checked = settings.installPromptEnabled;
            document.getElementById('installMessage').value = settings.installMessage;
            document.getElementById('installButton').value = settings.installButton;
            document.getElementById('installDelay').value = settings.installDelay;
            document.getElementById('installAutoHide').value = settings.installAutoHide;
            document.getElementById('installCount').textContent = settings.installCount;

            // Add listeners for all toggles
            const toggles = ['showOverload', 'showLockedPreviews', 'showCaptions',
                           'allowPageMode', 'allowFontSize', 'allowBookmarks', 'allowComments',
                           'twitterEmbeds', 'maintenanceMode', 'randomButtonText', 'credentialCarousel', 'installPromptEnabled'];

            toggles.forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    saveSetting(id, e.target.checked);
                });
            });

            // Install prompt text inputs
            ['installMessage', 'installButton'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    saveSetting(id, e.target.value);
                });
            });

            // Install prompt number inputs
            ['installDelay', 'installAutoHide'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    saveSetting(id, e.target.value);
                });
            });

            // Reset install prompt button
            const resetBtn = document.getElementById('resetInstallPrompt');
            resetBtn.addEventListener('click', () => {
                localStorage.removeItem('installPromptDismissed');
                resetBtn.textContent = 'Done!';
                resetBtn.classList.add('done');
                setTimeout(() => {
                    resetBtn.textContent = 'Reset';
                    resetBtn.classList.remove('done');
                }, 2000);
            });
        }

        // Media form functionality
        const addBtn = document.getElementById('addMediaBtn');
        const addForm = document.getElementById('addForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const generateBtn = document.getElementById('generateBtn');
        const outputSection = document.getElementById('outputSection');
        const mediaCodeEl = document.getElementById('mediaCode');
        const spanCodeEl = document.getElementById('spanCode');
        const chapterSelect = document.getElementById('mediaChapter');

        // Chapter titles for dropdown
        const chapters = [
            'TRUST THE PROCESS', 'GRAPEFRUIT', 'EARNING IT', 'A CAGED TIGER',
            'THE BIGS', 'HITTERS COUNT', 'THE HOT STOVE', 'FIRE DRILL',
            'PRIME-TIME', 'GLOBETROTTING', 'THE OTHER SHOE', 'UNETHICAL',
            'CHANGE OF SCENERY', 'ENEMY LINES', 'A LETTER TO THE EDITOR',
            'TURNING POINT', 'OPENING DAY', 'MAGIC NUMBER', 'OCTOBER',
            'HOT COFFEE', 'THE FUTURE', 'THE WHITE FLAG', 'INSIDE BASEBALL',
            'BURN OUT', 'THE BIG ONE', 'ROAD TO OMAHA'
        ];

        // Populate chapter dropdown
        chapters.forEach((title, i) => {
            const opt = document.createElement('option');
            opt.value = i + 1;
            opt.textContent = `${i + 1}. ${title}`;
            chapterSelect.appendChild(opt);
        });

        const iconMap = {
            photo: 'üì∑',
            newspaper: 'üì∞',
            link: 'üîó',
            tweet: 'üê¶',
            email: '‚úâÔ∏è',
            text: 'üí¨',
            video: 'üé¨',
            audio: 'üéôÔ∏è'
        };

        addBtn.addEventListener('click', () => {
            addForm.classList.add('active');
        });

        cancelBtn.addEventListener('click', () => {
            addForm.classList.remove('active');
            outputSection.style.display = 'none';
        });

        generateBtn.addEventListener('click', () => {
            const chapter = chapterSelect.value;
            const chapterTitle = chapterSelect.options[chapterSelect.selectedIndex].text;
            const type = document.getElementById('mediaType').value;
            const caption = document.getElementById('mediaCaption').value;
            const filename = document.getElementById('mediaSrc').value;
            const icon = iconMap[type] || 'üì∑';

            // Generate a simple ID from chapter and type
            const id = `ch${chapter}-${type}-${Date.now().toString().slice(-4)}`;

            const mediaCode = `    '${id}': {
        type: '${type}',
        emoji: '${icon}',
        label: '${type.charAt(0).toUpperCase() + type.slice(1)}',
        caption: '${caption}',
        src: './assets/${filename}',
        placeholder: false
    },`;

            const spanCode = `<span class="media-emoji" data-media-id="${id}">${icon}</span>`;

            mediaCodeEl.textContent = mediaCode;
            spanCodeEl.textContent = spanCode;
            outputSection.style.display = 'block';
        });

        // Copy buttons
        document.querySelectorAll('.copy-btn[data-target]').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = document.getElementById(btn.dataset.target);
                navigator.clipboard.writeText(target.textContent);
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        });

        // Table sorting
        const table = document.getElementById('catalogTable');
        const headers = table.querySelectorAll('th[data-sort]');
        let sortDir = {};
        let currentData = [...allMedia];

        const sortKeys = { status: 'statusSort', icon: 'icon', id: 'id', chapterNum: 'chapterNum', chapterName: 'chapterName', date: 'date', time: 'time' };

        headers.forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.sort;
                const key = sortKeys[col];

                // Toggle direction
                sortDir[col] = sortDir[col] === 'asc' ? 'desc' : 'asc';
                const dir = sortDir[col];

                // Update arrows
                headers.forEach(h => {
                    h.classList.remove('sorted');
                    h.querySelector('.sort-arrow').textContent = '‚Üï';
                });
                th.classList.add('sorted');
                th.querySelector('.sort-arrow').textContent = dir === 'asc' ? '‚Üë' : '‚Üì';

                // Sort data
                currentData.sort((a, b) => {
                    const aVal = (a[key] || '').toString();
                    const bVal = (b[key] || '').toString();
                    const cmp = aVal.localeCompare(bVal);
                    return dir === 'asc' ? cmp : -cmp;
                });

                // Re-render
                renderTable(currentData);
            });
        });

        init();

        // Legend toggle
        const legendBtn = document.getElementById('legendBtn');
        const legendDropdown = document.getElementById('legendDropdown');
        legendBtn.addEventListener('click', () => {
            legendDropdown.classList.toggle('show');
        });

        // Populate inline chapter dropdown
        const inlineChapterSelect = document.getElementById('inlineChapter');
        CHAPTERS.forEach((ch, i) => {
            const opt = document.createElement('option');
            opt.value = ch.id;
            opt.textContent = `${ch.id}. ${ch.title}`;
            inlineChapterSelect.appendChild(opt);
        });

        // Inline add form handler
        const inlineAddBtn = document.getElementById('inlineAddBtn');
        inlineAddBtn.addEventListener('click', () => {
            const status = document.getElementById('inlineStatus').value;
            const emoji = document.getElementById('inlineEmoji').value;
            const mediaId = document.getElementById('inlineId').value.trim();
            const chapterVal = document.getElementById('inlineChapter').value;
            const time = document.getElementById('inlineTime').value.trim();

            if (!mediaId) {
                alert('Please enter a Media ID');
                return;
            }

            // Get chapter info
            const chapterNum = chapterVal ? parseInt(chapterVal) : null;
            const chapterName = chapterNum ? CHAPTERS.find(c => c.id === chapterNum)?.title : null;

            // Determine status emoji
            const statusEmoji = status === 'green' ? 'üü¢' : status === 'yellow' ? 'üü°' : 'üî¥';

            // Generate media.js code
            const placeholder = status === 'yellow';
            const typeMap = {
                'üì∑': 'photo',
                'üì∞': 'newspaper',
                'üîó': 'link',
                'üê¶': 'tweet',
                '‚úâÔ∏è': 'email',
                'üí¨': 'text',
                'üé¨': 'video',
                'üéôÔ∏è': 'audio'
            };
            const type = typeMap[emoji] || 'photo';

            const mediaCode = `    '${mediaId}': {
        type: '${type}',
        emoji: '${emoji}',
        label: '${type.charAt(0).toUpperCase() + type.slice(1)}',
        caption: '',
        src: './assets/${mediaId}',${time ? `\n        duration: '${time}',` : ''}
        placeholder: ${placeholder}
    },`;

            const spanCode = `<span class="media-emoji" data-media-id="${mediaId}">${emoji}</span>`;

            // Show the output in the existing modal form
            document.getElementById('mediaCode').textContent = mediaCode;
            document.getElementById('spanCode').textContent = spanCode;
            document.getElementById('addForm').classList.add('active');
            document.getElementById('outputSection').style.display = 'block';

            // Clear inline form
            document.getElementById('inlineId').value = '';
            document.getElementById('inlineTime').value = '';
        });
    </script>
</body>
</html>
